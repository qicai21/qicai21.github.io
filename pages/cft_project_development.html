<!DOCTYPE html>
<html lang="zh_cn" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>粮食价格信息抓取项目记录 - qicai21.github.io</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://pages/cft_project_development.html">

        <meta name="author" content="Burgam" />
        <meta name="description" content="抓取ChinaFeedTrading的价格信息,并自动生成格式化报文项目.涉及request抓取, regex, mongodb, matplotlib等." />

    <meta property="og:site_name" content="qicai21.github.io" />
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="粮食价格信息抓取项目记录"/>
    <meta property="og:url" content="https://pages/cft_project_development.html"/>
    <meta property="og:description" content="抓取ChinaFeedTrading的价格信息,并自动生成格式化报文项目.涉及request抓取, regex, mongodb, matplotlib等." />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://theme/css/style.css" type="text/css"/>

        <link href="https://feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="qicai21.github.io ATOM Feed"/>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://" class="navbar-brand">
qicai21.github.io            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://pages/about_linux_file_system.html">
                             linux系统文件简述
                          </a></li>
                         <li><a href="https://pages/install_ubuntu_to_new_pc.html">
                             新装ubuntu小记录
                          </a></li>
                         <li class="active"><a href="https://pages/cft_project_development.html">
                             粮食价格信息抓取项目记录
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content" class="body">
        <h1 class="entry-title">粮食价格信息抓取项目记录</h1>
        
        <div class="entry-content">
            <h1>总体计划</h1>
<ol>
<li>目录页内容提取分析,抓到文章时间,类型,url</li>
<li>页面内容提取器,实现文章解析:<ul>
<li>能完整提取价格的各项信息:品质,地点,价格,于前日比较的情况;</li>
<li>能找到评论内容段落,简单处理评论(i.e. 将没用的评论内容删掉,留干货);</li>
<li>遇到无法识别的内容弹出对话框,要求添加解释器用于之后识别.</li>
</ul>
</li>
<li>建立数据库</li>
<li>目录迭代器,滚动向下查找第二页,第三页, 迭代器要跟数据库比对,没有收录的数据进行解析,收录的就忽略,支持full_inspection | simple_inspection两种模式.</li>
</ol>
<h1>Developing Log</h1>
<p><strong>12-15</strong></p>
<p>Directory Page Resolve methods are ready.可以实现对目录页内容的提取,分类,时间.</p>
<ul>
<li>get_price_list</li>
<li>li_content_resolve</li>
</ul>
<p><strong>12-17</strong></p>
<p>实现了分析价格的部分,但代码整体比较乱,正在考虑如何重构代码.</p>
<p>需要一个语句解释器:
- 锦州港地区水分15%新粮收购价2500-2530元/吨,默认贸易商收购价
- 黑龙江哈尔滨地区新玉米收购价格在2335-2385元/吨，下跌10元/吨，水分15%</p>
<p>也就是说价格信息分为3种,一种是国内市场总体情况,一种是区域市场具体价格,一种是南北港价格比较.三个报告,三个解释器,统一继承于一个父类,统一的方法,要重新构思</p>
<p>能post数据到数据库,mongodb</p>
<p>文章要不要建一个文章类呢?带有他们自己的pattern_manager</p>
<p><strong>12-20</strong></p>
<p>国内,东北,南北港样品文章(12-18日)已经能正常解析成数据.</p>
<p>在此环节需要git一下了.</p>
<p>剩余主要任务:</p>
<ul>
<li>首页迭代器尚未创建</li>
<li>pyqd那个界面装上</li>
<li>连上数据库</li>
</ul>
<p>当前代码主要缺陷:
- page category 换成中文的
- Row 34 @CFTPage.py: __set_comment_content这个名字太烂了,换一个
- 注释不完整,命名也该调整一下
- 换行真的很头疼</p>
<p><strong>python-json 写入中文问题</strong></p>
<p>重要的就是open时的encoding和dump的ensure_ascii参数</p>
<div class="highlight"><pre><span></span><code><span class="err">```python</span>
<span class="err">with open(&quot;traders.json&quot;, &quot;w&quot;, encoding=&quot;utf-8&quot;) as writefile:</span>
<span class="err">    json.dump(data_str, writefile, ensure_ascii=False, indent=4)</span>
<span class="err">```</span>
</code></pre></div>

<p><strong>12-28</strong></p>
<p>完成图了mongodb和pymongo的学习,回来调整代码.</p>
<h1>第一阶段完成</h1>
<blockquote>
<h1>Congratulations! [2020-12-31 05:44]</h1>
<p>数据已经爬完,正逢2020-12-31,在这最后的时间里,总结一下,承前启后.</p>
</blockquote>
<p>截至12-31,下载完所有的2018-2020年的数据,git 版本号为:</p>
<div class="highlight"><pre><span></span><code>commit ffdf6ee8b4f9b5d60a8d4af97104e555a1bbbfab <span class="o">(</span>HEAD -&gt; master<span class="o">)</span>
Author: qicai21 &lt;qicai21@gmail.com&gt;
Date:   Thu Dec <span class="m">31</span> <span class="m">22</span>:30:23 <span class="m">2020</span> +0800

    CFT price and commantaries data <span class="m">2018</span>-2020, download completed!
</code></pre></div>

<h3>重要知识点</h3>
<hr>
<h4>logging</h4>
<p>过往的代码中日志被忽略,主要原因是代码只在很有有限的范围内运行,输出到控制台上与输出到日志中没有多大不同.但实际的程序运行中并非如此,程序要连续的运行,你需要知道发生了什么,对哪些数据选择了何种方式进行处理,是默认pass掉还是被当成另一种数据被解析了;有哪些不打紧的异常被pass掉了,等等这些.</p>
<p><a href="https://www.cnblogs.com/yyds/p/6901864.html">Python之日志处理（logging模块）</a></p>
<h4>Custom Exception</h4>
<p>爬网页时利用自定义的异常来,可以实现不同模块之间功能的衔接,能避过分复杂的参数被传来传去.</p>
<h4>json and file operation</h4>
<p>将控制台输入缓存起来,这样就可以避免大量的重复性输入,但要注意缓存的生命周期,为避免全局变量,其实将其存入数据库或者放到一个json文件中也不错.重点是json文件想要保存中文,就要避免其默认的ascii转码处理. <code>dumps</code> vs <code>loads</code>, <code>dump</code>vs <code>load</code>要分分清楚. 这里我的理解是: <code>dumps</code>和<code>loads</code>是"dump-to-string", "load-from-string"的意识,其操作都是json-string这一特殊的东西,而dump和load则是文件对象.</p>
<p><code>python
  with open("traders.json", "w", encoding="utf-8") as writefile:
      json.dump(data_str, writefile, ensure_ascii=False, indent=4)</code></p>
<h4>regex</h4>
<p>linux命令行,vim搜索,数据库数据匹配,网页解析,文意解析,数据提取,可以说regex简直神技!<strong>奥义在于使用字符组成的结构进行文本检索,而不限定于字符本身.</strong></p>
<ul>
<li>
<p>re.compile.find 是否有顺序要求? -- 有的</p>
</li>
<li>
<p>re.compile能不能接受str.format方式来构造 --可以这样,但是<code>{}</code>符号在解析时会冲突,不建议这样做.</p>
</li>
</ul>
<p><code>python
  ptn1 = re.compile(r"\s{2}{n}.*?old".format(n=1)) # 这个就会报错
  ptn2 = re.compile(r"\s{2}\d.*?old")
  ptn2.findall("lili is  1 years old")</code></p>
<ul>
<li>regex的非匹配</li>
</ul>
<p>```python
  txt1 = "东北地区玉米深加工企业调价之外大部企稳"
  txt2 = "东北地区玉米ddgs企业成交价190-元"</p>
<p># 匹配1不匹配2
  commc = re.compile(r"东北地区([^0-9a-zA-Z])<em>$")
  price = re.compile(r"东北地区\w</em>(收购|价).*[0-9-]{4}元?")
  price.search(txt2)
  ```</p>
<p><strong>group and capture expression: ?: &amp; ?= &amp; ?!</strong></p>
<p>re.findall依赖括号进行匹配,表达式中同样存在或关系时如: "(水分|水份)(/d{2})%"就尴尬了,此时就用到了<code>?:</code>:</p>
<p><code>python
  pttn = re.compile(r"(?:水分|水份)[\u4e00-\u9fa5]*\s*(\d{2}\.?\d*)\s*%")
  text = "水分15%玉米贸易商收购价格为2440-2500元/吨"
  pttn.findall(text)
  # 取消掉了水分括号的捕获含义</code></p>
<p>?= 和 ?!看下边.</p>
<blockquote>
<p>The difference between <code>?=</code> and <code>?!</code> is that the former requires the given expression to match and the latter requires it to <strong>not</strong> match. For example <code>a(?=b)</code> will match the "a" in "ab", but not the "a" in "ac". Whereas <code>a(?!b)</code> will match the "a" in "ac", but not the "a" in "ab".</p>
</blockquote>
<p><strong>这个技巧很重要!!</strong></p>
<ul>
<li>断言——<strong>(?!pattern) 零宽负向先行断言</strong> 或者 <strong>(?&lt;!--pattern) 零宽负向后行断言</strong> 均可。</li>
</ul>
<p>这个就是不以pattern开头/结尾的匹配</p>
<ul>
<li>regex和文本分析的机器学习模块</li>
</ul>
<p>--&gt; 这里并不是说regex来代替文本分析,实际上,完全没有办法对比.但是如果不了解文本分析模块时,regex几乎是能用来处理文本的唯一工具了.这里要备案一下文本处理工具.其实这些工具如同numpy&amp;pandas&amp;matpoltlib一样,是并行交替使用的.</p>
<blockquote>
<p><a href="https://www.jiqizhixin.com/articles/2018-10-29-26">8种Python文本处理工具集</a></p>
</blockquote>
<h4>tqdm</h4>
<p>不仅是一个好的装饰,其交互性也更直观,有什么比看着进度条一直走更excited的事呢!</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">def</span> <span class="nf">extract_data_all_of_the_links</span><span class="p">(</span><span class="n">links</span><span class="p">):</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">links</span><span class="p">)</span>                                                  
    <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bar</span><span class="p">:</span>                                                            
        <span class="n">bar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">show_page_info</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>                                                                    <span class="n">extract_page_data</span><span class="p">(</span><span class="o">**</span><span class="n">link</span><span class="p">)</span> 
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">show_page_info</span><span class="p">(</span><span class="n">dict_item</span><span class="p">):</span> 
    <span class="n">d</span> <span class="o">=</span> <span class="n">dict_item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>  
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">dict_item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: report of </span><span class="si">{</span><span class="n">dict_item</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">]&quot;</span>
</code></pre></div>

<h4>javascript</h4>
<p>这个真的,chrome console 会用到,mongodb会用到,大量控制台都是javascript的天下.</p>
<blockquote>
<p>关于javascript基础,<a href="https://www.w3cplus.com/javascript/6-ways-to-declare-javascript-functions.html">声明JavaScript函数的六种方法</a>一文真的很好,里边的用例基本上涵盖了大部分js的适用功能和写法.</p>
</blockquote>
<ul>
<li><strong>声明变量</strong></li>
</ul>
<p>使用var声明的变量，其作用域为该语句所在的函数内，且存在变量提升现象；变量提升现象就是先赋值后声明一样能起作用.</p>
<p>使用let声明的变量，其作用域为该语句所在的代码块内，不存在变量提升；</p>
<p>使用const声明的是常量，在后面出现的代码中不能再修改该常量的值。 const比较好理解.</p>
<p>```javascript
  function varTest() {
    var x = 1;
    if (true) {
      var x = 2;  // 同样的变量!
      console.log(x);  // 2
    }
    console.log(x);  // 2
  }</p>
<p>function letTest() {
    let x = 1;
    if (true) {
      let x = 2;  // 不同的变量
      console.log(x);  // 2
    }
    console.log(x);  // 1
  }
  ```</p>
<ul>
<li>
<p><strong>创建一个函数</strong></p>
<p>函数的声明方式可以拆解为一个匿名函数+声明一个变量来指向这个函数,2个过程写在了一起.</p>
<p>另外有<code>=&gt;</code>这种语法糖的支持.</p>
<p>```javascript
(function(chars){console.log("it's " + chars);})
var show_chars;
show_chars = (function(chars){console.log("it's " + chars);})</p>
<p>// 所以,以下任何一种方式都可以使用
var show_chars(chars){console.log("it's + chars");}
var show_chars = (function(chars){console.log("it's " + chars);})
var show_chars = (chars) =&gt; {console.log("it's " + chars);}
```</p>
</li>
<li>
<p><strong>创建一个类</strong></p>
<p>```javascript
class Names { 
    constructor (names) { 
        this.names = names; 
    } 
    contains(names) { 
        return names.every((name) =&gt; this.names.indexOf(name) !== -1); 
    } 
} </p>
<p>var countries = new Names(['UK', 'Italy', 'Germany', 'France']); 
countries.contains(['UK', 'Germany']); // =&gt; true 
countries.contains(['USA', 'Italy']); // =&gt; false
```</p>
</li>
<li>
<p><strong>if-else循环怎么写</strong></p>
<p><code>javascript
if (condition1) {
  //  block of code to be executed if condition1 is true
} else if (condition2) {
  //  block of code to be executed if the condition1 is false and condition2 is true
} else {
  //  block of code to be executed if the condition1 is false and condition2 is false
}</code></p>
</li>
<li>
<p><strong>for循环怎么写</strong></p>
<p>```javascript
for (var ig = 0; ig &lt; 5; ig++) {
  console.log("The number is " + ig + "<br>");
};</p>
<p>// 下边省略了var也可以运行.
for (ig = 0; ig &lt; 5; ig++) {
  console.log("The number is " + ig + "<br>");
};</p>
<p>// for...in
var pairs = {"shenyang": "021", "yingkou": "0417"};
for (i in pairs){
    console.log(i + "city no: " + pairs[i]);
}</p>
<p>// for...of
var lst = ['bejing', 'shanghai', 'guangzhou'];
for (city of lst){console.log("i love " + city);}
```</p>
</li>
<li>
<p><strong>时间类型的处理</strong></p>
<p><code>javascript
var date = new Date("2020-12-31")
var d = new Date(2018, 11, 24, 10, 33, 30, 0);
d.getFullYear();</code></p>
</li>
<li>
<p><strong>list和dict类型</strong></p>
<p>这里注意Array的index规则与python不同</p>
<p>```javascript
var lst = ['bejing', 'shanghai', 'guangzhou'];
lst.indexOf("bejing") = 0
lst.indexOf("guangzhou") = 2
lst[lst.length-1] = "guangzhou"
lst.indexOf("shenzhen") = -1 // 没有的值会返回-1;python返回ValueError</p>
<p>var pairs = {"shenyang": "021", "yingkou": "0417"};
Object.keys(pairs);
Object.values(pairs);
```</p>
</li>
<li>
<p><strong>字符串的处理</strong></p>
<p>没有现成的string formater可用,自己声明,或直接用"str1" + variable + "str2"吧</p>
<p><code>javascript
if (!String.prototype.format) {
  String.prototype.format = function() {
    var args = arguments;
    return this.replace(/{(\d+)}/g, function(match, number) { 
      return typeof args[number] != 'undefined'
        ? args[number]
        : match
      ;
    });
  };
}</code></p>
</li>
<li>
<p><strong>对应print和input方法</strong></p>
<p><code>javascript
var ans = prompt("input something", "default string"); 
// 这个defuault string是输入框中默认显示的string,不是没输入返回的默认值.</code></p>
</li>
</ul>
<h4>xpath 和 chrome console</h4>
<p>一种方法是引入并使用jquery,通过<code>$('div', '.div_class')</code>来获取.但要确认jquery被正确的加载和使用.有些网页没有引用jquery,就要自己引用:</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">jq</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
<span class="nx">jq</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js&quot;</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">jq</span><span class="p">);</span>
</code></pre></div>

<p>另一种方式是直接使用xpath,<code>$x("//table//url/li")</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">$x</span><span class="p">(</span><span class="s2">&quot;//li/a[contains(@href, &#39;2019-08-27&#39;)]&quot;</span><span class="p">)</span> <span class="c1">// 所有href中有2019-08-27的a标签</span>
<span class="nx">$x</span><span class="p">(</span><span class="s2">&quot;//a[contains(@title, &#39;东北&#39;)]/ancestor::td&quot;</span><span class="p">)</span>  <span class="c1">// 所有含有带有title中有东北的a标签的td标签.</span>
</code></pre></div>

<h4>jupyter notebook使用本地python类</h4>
<p>在notebook中要import自己写的文件类,需要一点特殊设置</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">))</span>
<span class="k">if</span> <span class="n">module_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_path</span><span class="p">)</span>
</code></pre></div>

<h2>接下来的开发计划</h2>
<ul>
<li>把单日简单查询和同步功能添加上.</li>
</ul>
<p>做了daliy_update.py,执行这个更新第一页就ok.</p>
<ul>
<li>
<p>综合看一下下载的数据,反复用pandas玩几遍.</p>
</li>
<li>
<p>能output简单的日报,哪怕版本简陋也可以</p>
</li>
<li>
<p>查询大商所的数据,做同步下载</p>
</li>
<li>
<p>找到煤炭南北港价格的网站,并做同步</p>
</li>
<li>
<p>怎么爬网页表格数据</p>
</li>
<li>
<p>爬新闻标题,做新闻字段分析</p>
</li>
<li>
<p>报告形成视频号内容</p>
</li>
</ul>
<blockquote>
<p>一点个人感想</p>
<ul>
<li>把大计划拆成小计划,一件一件的做简直太重要了,不然百行以上的项目真的很难下手,很难静下来动手去做.</li>
<li>git时,超过2个短局才能描述清楚时,那就以为着你漏掉了该commit 的点.适时的git真的是一个好的习惯,好习惯靠训练的.</li>
<li>--ditto--</li>
</ul>
</blockquote>
<h2>二阶段开发草记</h2>
<ol>
<li>如何使jupyter notebook完全显示dateframe</li>
</ol>
<p><code>python
   pd.options.display.max_columns = None # 取消列缺省
   pd.options.display.max_rows = None # 取消行缺省</code></p>
<ol>
<li>让dateframe带颜色</li>
</ol>
<p><code>python
   df.style.applymap(render,subset=["涨跌"] ) # 这个subset参数支持pandas.IndexSlice[],具体设置根据情况google</code></p>
<ol>
<li>利用dataframe_image模块将dataframe转成img</li>
</ol>
<p>优点,代码简单,直接保存图片就行;缺点:图片的分辨率无法调节,清晰度马马虎虎,很多东西不能定制.</p>
<p>```python</p>
<p>import dataframe_image as dfi</p>
<p># 已经有new_df, 将其columns渲染一下,保存依然有效果
   export_styled = new_df.style.applymap(render_with_value, subset=["涨跌"])
   dfi.export(export_styled, "./eg_df_image.png")
   ```</p>
<ol>
<li>dataframe的multiIndex</li>
</ol>
<p><code>pythonl
   region = ["beijing", "beijing", "shanghai", "shanghai", "dalian", "guangzhou"]
   numbers = [1, 2, 3, 4, 5, 6]
   new_index = pd.MultiIndex.from_tuples(
        zip(regions, numbers),
        names=['地区', 'No']
   )</code></p>
<ol>
<li>可视化模块的选择</li>
</ol>
<p>用Python做数据分析时，用先<code>pandas</code>先进行数据处理，然后再用<code>Matplotlib</code>、<code>Seaborn</code>、<code>Plotly</code>、<code>Bokeh</code>等对<code>dataframe</code>或者<code>series</code>进行可视化操作。</p>
<p>从最新的<code>pandas</code>版本0.25.3开始，可以用<code>DataFrame.plot</code>画出简单图形。可以使用<code>Plotly</code>、<code>Bokeh</code>作为可视化的backend，直接实现交互性操作，并简化和统一了参数。</p>
<p>目前，<code>pandas</code>的backend支持以下几个可视化包。</p>
<ul>
<li>
<p>Plotly</p>
</li>
<li>
<p>Holoviews</p>
</li>
<li>
<p>Matplotlib</p>
</li>
<li>
<p>Pandas_bokeh</p>
</li>
<li>
<p>Hyplot</p>
</li>
</ul>
<p>关于不同包的选择,仁者见仁,具体还要看场景.如果只是简单输出一下,就pd的plot就行,要是讲究样式,就要根据不同需求和场景选择合适的模块了.通常来讲,matplotlib更底层,功能更多,当然参数也更多,类似于编辑器中的<code>vim</code>和文本解释中的<code>regex</code>;<code>Plotly</code>和<code>Seaborn</code>就集成和简化了不少,有点xpath的感觉,最外边是pandas的plot,类比为beautifulsoup.</p>
<p>```python
   pd.options.plotting.backend = 'plotly'</p>
<p>"""
   df as :
    page_date   region  price_low
   0    2020-01-15  东北最高    1600.000000
   0    2020-01-15  东北平均    1572.500000
   11388    2020-01-15  绥化淀粉    1672.000000
   1    2020-01-17  东北最高    1600.000000
   1    2020-01-17  东北平均    1572.500000
   ...plotly.graph_objs._figure.Figure
   """
   shapiro(a)
   fig = df.plot.scatter(y='price_low', x='page_date', color='region')
   fig.show()
   ```</p>
<p>plotly优点是可以交互,挺好看的,以及方便的转为html.但基于我个人的一贯鸟行,我选择matplotlib, 当然,这里还有一个重要的点,就是如何生成html,matplotlib可以,但是需要指定专门backend,这点稍后再探讨.</p>
<blockquote>
<p><strong>关于<code>matplotlib</code></strong></p>
<p>plot, pyplot, subplots.  figure and axes.</p>
<p><a href="https://matplotlib.org/tutorials/introductory/usage.html#sphx-glr-tutorials-introductory-usage-py">matplotlib官方文档-基础章节一</a></p>
<p>Tick, Locator and Formatter</p>
<p><a href="https://jishuin.proginn.com/p/763bfbd2d660">Matplotlib绘图遇到时间刻度...</a></p>
</blockquote>
<p><img alt="一张图看懂matplotlib" src="/home/guodb/.config/Typora/typora-user-images/image-20210114065424444.png"></p>
<p>如何呈现数据,我碰到了一个非常困扰我的问题,在这个问题上花费的时间远比其他加一起都多.</p>
<ul>
<li>清晰的坐标</li>
<li>一个坐标轴提取和设置的方法</li>
<li>不要牛逼,要大家能看得懂: </li>
<li>即时价格和15日均价</li>
<li>不同地区</li>
<li>全国图<ul>
<li>东北地区</li>
<li>山东</li>
<li>华北</li>
<li>南方销区</li>
</ul>
</li>
<li>东北<ul>
<li>黑龙江</li>
<li>内蒙</li>
<li>吉林</li>
<li>辽宁</li>
</ul>
</li>
<li>山东,华北,南方<ul>
<li>南方可能会分</li>
</ul>
</li>
<li>
<p>港口价格走势</p>
</li>
<li>
<p>输出方案的选择</p>
</li>
</ul>
<p>以如下df为例,可选方案有三:</p>
<p><code>python
   data = dict(
       cat=np.random.choice(['sun', 'moon', 'stars'], 20),
       date=pd.date_range(end='2021-1-19', periods=20),
       value=(np.random.randn(20)*1000).astype(np.int32),
       count=np.random.randint(4, 10, 20)
   )
   df = pd.DataFrame(data)</code></p>
<ul>
<li>
<p>将dataframe,plot依次转成html-table,和canvas,然后将html转成所需要的pdf或image.</p>
<p>```python
 # dataframe 有直接to_html方法
 df.to_html()</p>
<p># plot就需要先用plotly画出来,因为plotly支持write_html和to_html方法.
 pd.options.plotting.backend = 'plotly'
 fig = df.plot.scatter(x='date', y='value', color='cat')
 fig.write_html('test_canvas.html')
 ```</p>
</li>
<li>
<p>将dataframe,plot都转成图片,嵌入到最终输出的文档中,e.g.: markdown或html,然后再拼接.</p>
<p>如下给出dataframe输出为图片的完整示例,略去scatter-line的部分.</p>
<p>```python
 import matplotlib.pyplot as plt
 from pandas.plotting import table</p>
<p>fig = plt.figure(figsize=(5, 6), dpi=1400)
 ax = fig.add_subplot(111, frame_on=False)
 ax.xaxis.set_visible(False)
 ax.yaxis.set_visible(False)</p>
<p>table(ax, df, loc='center')
 plt.savefig('df_image_HD.png')
 ```</p>
</li>
<li>
<p>将dataframe转成html,plot存成image,并于html中引用,然后将html转成image.</p>
<p>这个是我最终选择的方案,不一定是最优方案,但满足了该阶段学习了解matplotlib的需求,同时方案二中将df画成table的方法有其弊端,就是间距和table的样式调整非常费力,远不如将其html化,然后通过bootstrap来配置样式方便.</p>
<p>至于plot转成图片还是html,这个看需求,复杂图片,不需要交互就matplotlib转图片;数据相对简单,有渲染成可交互html的svg就用plotly,特别是plotly渲染天生与bootstrap完美结合.</p>
</li>
<li>
<p>html转image和pdf的转换</p>
</li>
</ul>
<p>这里会使用一个module, imgkit,他调用的是qt4,实现将html转换成img.这里有个小tips,imgkit最找是用来将jupyter notebook转为image的.</p>
<p><a href="https://pypi.org/project/imgkit/">kitimg的官网</a></p>
<p><a href="https://blog.csdn.net/threegirl/article/details/81107939?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-7.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-7.control">pythonhtml2image: imgkit 和 wkhtmltoimage的坑</a></p>
<p>```python
   import imgkit</p>
<p># 可以将网页输出为图片
   imgkit.from_url('http://google.com', 'out.jpg')
   # 可以将本地html文件转成图片
   imgkit.from_file('test.html', 'out.jpg')
   # 可以将字符串转成图片
   imgkit.from_string('Hello!', 'out.jpg')
   ```</p>
<ol>
<li>and something etc</li>
</ol>
<p><code>matplotlib</code>显示横纵坐标线和线型设置</p>
<p><code>python
   ax2.grid(axis='y')</code></p>
<p><code>matplotlib</code>风格设置</p>
<p><code>python
   plt.style.use('seaborn')</code></p>
<p><code>matplotlib</code>显示汉字</p>
<p><code>python
   plt.rcParams['font.sans-serif'] = ['WenQuanYi Micro Hei Mono']</code></p>
<p><code>matplotlib</code>的几种基本图形</p>
<p>scatter散点图,</p>
<p>plot画折线图,</p>
<p>bar条图,</p>
<p>hist画直方图,</p>
<p>box箱线图.</p>
<ol>
<li>Pandas的SettingwithCopyWarning</li>
</ol>
<p>经常遇到这种警告,说我们执行了类似<code>df['col'] = df['col_1'].apply(lambda x: func(x))</code>这种操作,说应该在copy上执行而不是在原df上.在代码中找又很麻烦,而warning又不提示具体位置,如果暴力的停用警告其实未必可取,反而可以通过将警告升级为异常来找出问题所在位置.</p>
<p>下边是用例:</p>
<p><code>python
   pd.set_option('mode.chained_assignment', 'raise')  # 把警告当成异常,会显示异常的位置
   pd.set_option('mode.chained_assignment', None)  # 忽略警告,直接执行
   data[data.bidder == 'parakeet2004']['bidderrate'] = 100</code></p>
<p><strong>附带说一句,通常问题出现在将df作为参数传入一个函数时,忘记了read_df=param_df这样的操作,导致df操作跨域了.</strong></p>
<ol>
<li>The part of hard-core</li>
</ol>
<p>scipy可以直接对数据进行验证,目前我们接触到的主要是正态分布验证以及画出分布状况.</p>
<p>画出分布状况</p>
<p><code>python
   from scipy import stats
   stats.probplot(df_area['dist'], dist='norm', plot=plt)</code></p>
<ul>
<li>
<p>正态分布</p>
<p>三种不同的验证算法,除第一种外通过return_result[-1]返回的P值可以查看是否符合正太分布,结果大于0.05就符合正太分布的预期.</p>
<p><code>python
 print(stats.shapiro(h_list))  # 偏小样本
 print(stats.kstest(h_list, 'norm'))  # 通用行强
 print(stats.normaltest(h_list))  # 专用,直接
 """ output
 ShapiroResult(statistic=0.9893901944160461, pvalue=0.7836505174636841)
 KstestResult(statistic=1.0, pvalue=0.0)
 NormaltestResult(statistic=0.39772650692006134, pvalue=0.8196619716081547)
 """</code></p>
<p><strong>当然也可以自己画正太函数的曲线,更多方式看:</strong> (<a href="https://www.cnblogs.com/judes/p/12627177.html">python正态分布</a>)</p>
<p><strong>正态分布</strong>的概率密度函数均值为$$\mu$$,方差为$$\sigma$$是高斯函数的一个实例：
 $$
 f(x, \mu, \sigma) = \frac{1}{\sigma\sqrt{2\pi}} exp(-\frac{(x-\mu)^2}{2 \sigma^2})
 $$
 其具体的python函数可表示为:</p>
<p>```python
 def normfun(x, y):
     mu = y.mean()
     sigma = values.std()
     pdf = np.exp(-((x - mu)<strong>2)/(2*sigma</strong>2)) / (sigma * np.sqrt(2*np.pi))
     return pdf</p>
<p>```</p>
<p>以下边的模拟数据为例,100个小朋友的随机身高,是否满足正太分布的检验是如何实现的.注意,这里并不需要统计汇总各个身高的数量,x永远是身高最小到最大的序列,y则是x的高斯函数.</p>
<p>```python
 import numpy as np
 import pandas as pd
 import matplotlib.pyplot as plt</p>
<p>h_list = np.random.randn(100)+115
 h_list_2 = np.round(h_list)
 df = pd.DataFrame(h_list_1, columns=['height'])</p>
<p>x = np.arange(min(df.height), max(df.height)+1, 0.1)
 y = normfun(x, df.height)
 plt.plot(x, y)
 plt.hist(df, bins=6, rwidth=0.5, density=True,)
 plt.show()
 ```</p>
</li>
<li>
<p>幂率分布</p>
<!--待补全-->
</li>
<li>
<p>线性回归</p>
<!--待补全-->
</li>
<li>
<p>拟合函数</p>
<p>这里只说什么是拟合函数,至于如何使用机器学习模块进行拟合,暂时不做讨论.</p>
<p>拟合函数就是根据根据将一组变量输入一个函数,得出结果与目标值相符(注意未必是相同),则我们说这个函数是目标数据的拟合函数.根据其参数数量的不同,其计算结果呈现过拟合和欠拟合状态.</p>
<p>如下为一个小的例题:</p>
<blockquote>
<p>沙漠面积逐年增加量为0.2, 0,4, 0.76公顷,问如下ABCD函数哪个拟合度最高.</p>
<p>A: $0.2 * x$   </p>
<p>B:$\frac{x^2 + 2x} {10} $</p>
<p>C: $\frac{2^x}{10}$</p>
<p>D: $0.2 + \log_{16} x$</p>
</blockquote>
<p>用python画出来就是:</p>
<p>```python
 x = [1, 2, 3]
 y = [0.2, 0.4, 0.76]
 y_a = lambda x: 0.2<em>x
 y_b = lambda x: (x</em><em>2 + 2</em>x) / 10
 y_c = lambda x: 2**x / 10
 y_d = lambda x: (0.2 + (np.log(x) / np.log(16))) if x &gt;0 else None</p>
<p>x1 = np.arange(0, 4, 0.1)</p>
<p>fig, ax = plt.subplots()
 plt.plot(x, y, lw=0, marker='o',ms=5, mfc='w')
 plt.plot(x1, [y_a(i) for i in x1], color='red')
 plt.plot(x1, [y_b(i) for i in x1], color='g')
 plt.plot(x1, [y_c(i) for i in x1], color='pink')
 plt.plot(x1, [y_d(i) for i in x1], color='yellow')
 ax.set_ylim((-0.5, 3))
 ```</p>
</li>
</ul>
        </div>
    </section>
        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="#"><i class="fa fa-you-can-add-links-in-your-config-file-square fa-lg"></i> You can add links in your config file</a></li>
    <li class="list-group-item"><a href="#"><i class="fa fa-another-social-link-square fa-lg"></i> Another social link</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="https://getpelican.com/" target="_blank">Pelican</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.python.org/" target="_blank">Python.org</a>
    </li>
    <li class="list-group-item">
      <a href="https://palletsprojects.com/p/jinja/" target="_blank">Jinja2</a>
    </li>
    <li class="list-group-item">
      <a href="#" target="_blank">You can modify those links in your config file</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy;  Burgan
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://theme/js/respond.min.js"></script>




</body>
</html>